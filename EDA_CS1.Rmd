---
title: "Case Study 1 DDS 6306"
author: "Cameron Stewart and Adam Alidra"
date: "2/14/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in Data

```{r}
library(naniar)
library(stringr)
library(class)
library(caret)
library(e1071)
library(plyr)
library(dplyr)
library(ggthemes)
library(tidyverse)

#Read in beers.csv and convert variables to the appropriate class. Also change the 'Name' column to be more specific due to conflict in the other dataset

beers = read.csv("~/Documents/SMU_DS/Doing Data Science/DDS_Git/Doing-Data-Science/Unit 8 and 9 Case Study 1/Beers.csv",header = TRUE)

#beers = read.csv('/Users/adalidra/Desktop/Data Science Program/DS6306/MSDS_6306_Doing-Data-Science/Unit 8 and 9 Case Study 1/Beers.csv',header = TRUE)

colnames(beers)[1]="Beer_Name"
beers$Beer_ID = as.factor(beers$Beer_ID)
beers$Brewery_id = as.factor(beers$Brewery_id)
beers$Style = as.factor(beers$Style)
summary(beers)
str(beers)

#Read in breweries.csv and convert variables to the appropriate class. Also change the 'Name' column to be more specific due to conflict with the other dataset

breweries = read.csv("~/Documents/SMU_DS/Doing Data Science/DDS_Git/Doing-Data-Science/Unit 8 and 9 Case Study 1/Breweries.csv",header = TRUE)

#breweries = read.csv('/Users/adalidra/Desktop/Data Science Program/DS6306/MSDS_6306_Doing-Data-Science/Unit 8 and 9 Case Study 1/Breweries.csv',header = TRUE)

colnames(breweries)[2] = "Brewery_Name"
breweries$Brew_ID = as.factor(breweries$Brew_ID)
breweries$City = as.factor(breweries$City)
breweries$State = as.factor(breweries$State)
str(breweries)
```

## Find the numer of Breweries located in each state

```{r}
breweries_by_state = data.frame(breweries %>% group_by(State) %>% summarise(Count = n()) %>% arrange(desc(Count)))

breweries_by_state

breweries_by_state$State= fct_reorder(breweries_by_state$State, desc(breweries_by_state$Count))

head(breweries_by_state,25) %>% ggplot(aes(x=reorder(State,-Count),y=Count))+geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Count of Breweries") + ggtitle("Count of Breweries per State","Top 25 States") + theme(axis.text.x=element_text(angle=45, hjust=1))

#Adding combined chart of all 51 states (doesn't output in knit file well)
breweries_by_state %>% ggplot(aes(x=reorder(State,-Count),y=Count))+geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Count of Breweries") + ggtitle("Count of Breweries per State") + theme(axis.text.x=element_text(angle=45, hjust=1))
```

## total number of breweries in each state

breweries_by_state = data.frame(breweries %>% group_by(State) %>% summarise(Count = n()) %>% arrange(desc(Count)))
breweries_by_state
head(breweries_by_state, 51) %>% ggplot(aes(x=reorder(State,-Count),y=Count))+geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Count of Breweries") + ggtitle("Count of Breweries per State", "50 States and DC") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1))

## Merge beer data with the breweries data. Printing the first 6 observations and the last 6 observations to check the merged file.

```{r}
#Performed outer merge

beers_merge=merge(beers,breweries,by.x = "Brewery_id", by.y = "Brew_ID")
str(beers_merge)
head(beers_merge,6)
tail(beers_merge,6)
beers_merge[beers_merge$State==' SD',]
```

## Address the NA values

```{r}
#Summarize NA for each variable in all three dataframes. Then visualize the merged dataframe NAs
miss_var_cumsum(beers)
miss_var_cumsum(breweries)
miss_var_cumsum(beers_merge)
gg_miss_var(beers_merge) + ggtitle("Missing Values per Variable in Merged Dataset") + theme(axis.text.x=element_text(size= 12))
```

#### The brewries data frame has no NA values but the beers data frame has 1067 NA values. When the two tables are merged together, the 1067 NA values from the beers data frame are transferred to the beers_merge data frame. There are 1005 NA values in IBU and 62 NA values in ABV.

## Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare

```{r}
#Create summarized data frame with ABV and IBU medians
ABV_IBU_by_state = data.frame(beers_merge %>% group_by(State) %>% summarise(median_ABV = median(ABV,na.rm = TRUE), median_IBU = median(IBU,na.rm = TRUE)))

#Re-order the factors for median_ABV so the bar chart can be plotted in descending order
ABV_IBU_by_state$State= fct_reorder(ABV_IBU_by_state$State, desc(ABV_IBU_by_state$median_ABV))

#Arrange the data frame where median_ABV is in descending order so that the data frame can be sliced
ABV_IBU_by_state = ABV_IBU_by_state %>% arrange(desc(median_ABV))

#Due to the plot being too cluttered when plotting all states at once, slice the data frame in half and make two bar charts
head(ABV_IBU_by_state,25) %>% ggplot(aes(x=State,y=median_ABV)) + geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Median ABV") + ggtitle("Median ABV by State","Top 25 States") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1)) + scale_y_continuous(breaks = seq(0,0.07,0.01),limits = c(0,0.065))

tail(ABV_IBU_by_state,26) %>% ggplot(aes(x=State,y=median_ABV)) + geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Median ABV") + ggtitle("Median ABV by State","Bottom 26 States") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1)) + scale_y_continuous(breaks = seq(0,0.06,0.01),limits = c(0,0.065))

#Adding combined chart of all 51 states (doesn't output in knit file well)
ABV_IBU_by_state %>% ggplot(aes(x=State,y=median_ABV)) + geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Median ABV") + ggtitle("Median ABV by State") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1)) + scale_y_continuous(breaks = seq(0,0.07,0.01),limits = c(0,0.065))



#Repeat steps above to plot median_IBU       
ABV_IBU_by_state$State= fct_reorder(ABV_IBU_by_state$State, desc(ABV_IBU_by_state$median_IBU))

ABV_IBU_by_state = ABV_IBU_by_state %>% arrange(desc(median_IBU))

head(ABV_IBU_by_state,25) %>% ggplot(aes(x=State,y=median_IBU)) + geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Median IBU") + ggtitle("Median IBU by State","Top 25 States") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1)) + scale_y_continuous(breaks = seq(0,65,10),limits = c(0,62))

tail(ABV_IBU_by_state,26) %>% ggplot(aes(x=State,y=median_IBU)) + geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Median IBU") + ggtitle("Median IBU by State","Bottom 26 States") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1)) + scale_y_continuous(breaks = seq(0,65,10),limits = c(0,62))

#Adding combined chart of all 51 states (doesn't output in knit file well)
ABV_IBU_by_state %>% ggplot(aes(x=State,y=median_IBU)) + geom_bar(stat = 'identity',color='skyblue',fill='steelblue') + xlab("State") + ylab("Median IBU") + ggtitle("Median IBU by State") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1)) + scale_y_continuous(breaks = seq(0,65,10),limits = c(0,62))
```

## Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?

```{r}
#Max IBU beer
beers_merge[which(beers_merge$IBU==max(beers_merge$IBU,na.rm = TRUE)),]

#Max ABV beer
beers_merge[which(beers_merge$ABV==max(beers_merge$ABV,na.rm = TRUE)),]
```


## Comment on the summary statistics and distribution of the ABV variable.

```{r}
summary(beers_merge$ABV)

#Looking at beers between 9% and 10% ABV
dim(beers_merge[beers_merge$ABV<.1 & (beers_merge$ABV>.09 & !is.na(beers_merge$ABV)),])

#Plotting ABV Distribution
beers_merge %>% ggplot() + geom_boxplot(aes(x=ABV,y="All Beers"), color='skyblue', fill='steelblue') + ggtitle("Distribution of ABV Amongst All Beers") + coord_flip() + theme(axis.text.x=element_text(size= 14, hjust=.5))
```

##  Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.

```{r}
beers_merge %>% ggplot(aes(x=ABV,y=IBU)) + geom_point() + geom_smooth(method = "lm") + ggtitle("Plot of ABV and IBU of All Beers") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1))

#Linear model data (such as R-Squared)
summary(lm(IBU~ABV,data = beers_merge))
```

## Budweiser would also like to investigate the difference with respect to IBU and ABV between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA).  You decide to use KNN classification to investigate this relationship.  Provide statistical evidence one way or the other. You can of course assume your audience is comfortable with percentages … KNN is very easy to understand conceptually.

## In addition, while you have decided to use KNN to investigate this relationship (KNN is required) you may also feel free to supplement your response to this question with any other methods or techniques you have learned.  Creativity and alternative solutions are always encouraged.  

```{r}
#Convert all blank Styles to NA so they will be removed during cleaning
beers_merge[beers_merge==""]=NA #You can also do then when loading in the data

#Check dim of beers_merge and then check how many rows don't have any NAs
dim(beers_merge)
sum(complete.cases(beers_merge))

#Clean the dataset and verify dim of cleaned data
beers_merge_clean = na.omit(beers_merge)

#Reset row names after cleaning
beers_merge_clean[214,] #Example of why they need to be cleaned
row.names(beers_merge_clean) = 1:dim(beers_merge_clean)[1]
beers_merge_clean[214,]

#Reset factor levels of Style (because we removed blanks and NAs)
beers_merge_clean$Style = factor(beers_merge_clean$Style)

##Filter dataset to include only Ales and divide between IPA and non-IPA Ale
beers_merge_ale = beers_merge_clean[grep(x = beers_merge_clean$Style,pattern = '(\\bIPA\\b|\\bAle\\b)',ignore.case = TRUE),]
beers_merge_ale$IPA_or_Other_Ale = beers_merge_ale$Style
beers_merge_ale$IPA_or_Other_Ale = as.character(beers_merge_ale$IPA_or_Other_Ale)
beers_merge_ale$IPA_or_Other_Ale[grepl(x = beers_merge_ale$IPA_or_Other_Ale,pattern = '(\\bIPA\\b)',ignore.case = TRUE)]="IPA"
beers_merge_ale$IPA_or_Other_Ale[grep(x = beers_merge_ale$IPA_or_Other_Ale,pattern = '(\\bAle\\b)',ignore.case = TRUE)]="Other_Ale"
beers_merge_ale$IPA_or_Other_Ale = factor(beers_merge_ale$IPA_or_Other_Ale)

#Standardize values of input variables
beers_merge_ale$Z_ABV = scale(beers_merge_ale$ABV)
beers_merge_ale$Z_IBU = scale(beers_merge_ale$IBU)

#Repeat but with internal cross validation (we run multiple samples because of ties)
str(beers_merge_ale)
train_cols = beers_merge_ale[,12:13]
outcome_data = beers_merge_ale[,11]
num_rand_samples = 15
max_k = 55
accuracy_matrix = matrix(nrow = num_rand_samples,ncol = max_k)

for(i in 1:num_rand_samples)
{
  for(j in 1:max_k)
  {
    class_data = knn.cv(train_cols,cl = outcome_data,k=j)
    CM = confusionMatrix(table(class_data,outcome_data))
    accuracy_matrix[i,j] = CM$overall[1]
  }
}
 
MeanAcc = colMeans(accuracy_matrix)
which(MeanAcc==max(MeanAcc))
max(MeanAcc)
plot(seq(1,max_k,1),MeanAcc, type = "l") 
```


#Find another insight
```{r}
##Filter dataset to include only Ales and divide between IPA and non-IPA Ale
beer_style_breakdown = data.frame(beers_merge_clean %>% group_by(Style) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beers_merge_simplified_style = beers_merge_clean
str(beers_merge_clean$Style)
levels(beers_merge_clean$Style)
beers_merge_simplified_style$type = beers_merge_simplified_style$Style
beers_merge_simplified_style$type = as.character(beers_merge_simplified_style$type)
beers_merge_simplified_style$type[grepl(x = beers_merge_simplified_style$type,pattern = '(\\bIPA\\b)',ignore.case = TRUE)]="IPA "

beer_style_breakdown2 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown2

beers_merge_simplified_style$type[grepl(x = beers_merge_simplified_style$type,pattern = '(\\bLager\\b)',ignore.case = TRUE)]="Lager "

beer_style_breakdown3 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown3

beers_merge_simplified_style$type[grep(x = beers_merge_simplified_style$type,pattern = '(\\bRed Ale\\b|\\bAmber Ale\\b)',ignore.case = TRUE)]="Red_or_Amber_Ale "

beer_style_breakdown4 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown4

beers_merge_simplified_style$type[grep(x = beers_merge_simplified_style$type,pattern = '(\\bPale\\b)',ignore.case = TRUE)]="Pale Ale "

beer_style_breakdown5 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown5

beers_merge_simplified_style$type[grep(x = beers_merge_simplified_style$type,pattern = '(\\bStout\\b)',ignore.case = TRUE)]="Stout "

beer_style_breakdown6 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown6

beers_merge_simplified_style$type[grep(x = beers_merge_simplified_style$type,pattern = '(\\bPilsner\\b|\\bPilsener\\b)',ignore.case = TRUE)]="Pilsner "

beer_style_breakdown7 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown7

beers_merge_simplified_style$type[grep(x = beers_merge_simplified_style$type,pattern = '(\\bBlonde\\b)',ignore.case = TRUE)]="Blonde Ale "

beer_style_breakdown8 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown8

beers_merge_simplified_style$type[grep(x = beers_merge_simplified_style$type,pattern = '(\\bAle$)',ignore.case = TRUE)]="Other Ale "

beer_style_breakdown9 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown9

beers_merge_simplified_style$type[grep(x = beers_merge_simplified_style$type,pattern = '(\\S)$',ignore.case = TRUE)]="Other Non-Ale Beer "

beer_style_breakdown10 = data.frame(beers_merge_simplified_style %>% group_by(type) %>% summarise(Count = n(), ABV_median=median(ABV), IBU_median=median(IBU)) %>% arrange(desc(Count)))

beer_style_breakdown10

beers_merge_simplified_style %>% ggplot(aes(x=ABV,y=IBU)) + geom_point(aes(color=type)) + geom_smooth(method = "lm") + ggtitle("Plot of ABV and IBU of All Beers") + theme(axis.text.x=element_text(size= 10, angle=45, hjust=1))

#Using NB to predict beer type based on IBU and ABV
beers_merge_simplified_style$type = factor(beers_merge_simplified_style$type)
str(beers_merge_simplified_style)
dim(beers_merge_simplified_style)
iterations = 20

masterAcc = matrix(nrow = iterations)
masterSens = matrix(nrow = iterations)
masterSpec = matrix(nrow = iterations)

dim(beers_merge_simplified_style)

splitPerc = .7 #Training / Test split Percentage

for(j in 1:iterations)
{
  set.seed(j)
  trainIndices = sample(1:dim(beers_merge_simplified_style)[1],round(splitPerc * dim(beers_merge_simplified_style)[1]))
  train = beers_merge_simplified_style[trainIndices,]
  test = beers_merge_simplified_style[-trainIndices,]
  
  train_columns_split_model = train[,4:5]
  test_columns = test[,4:5]
  
  model = naiveBayes(train_columns_split_model,train$type)
  CM = confusionMatrix(table(predict(model,test_columns),test$type))
  masterAcc[j] = CM$overall[1]
  masterSens[j] = CM$byClass[1]
  masterSpec[j] = CM$byClass[2]
}

MeanAcc = colMeans(masterAcc)
MeanSens = colMeans(masterSens)
MeanSpec = colMeans(masterSpec)

MeanAcc
MeanSens
MeanSpec

#Loop 100 times to get a more consistent accuracy for NB
iterations = 50

masterAcc = matrix(nrow = iterations)
masterSens = matrix(nrow = iterations)
masterSpec = matrix(nrow = iterations)

splitPerc = .7 #Training / Test split Percentage
```